# M0-T1-01：构建触发与发布流程（定稿）

## 结论

- 触发方式：手动触发（本地或构建机执行一次 `npm run build`）。
- 构建产物：生成静态产物到仓库根目录的 `dist/`。
- 发布方式：Nginx 静态托管（`root` 指向 `dist/`，不引入额外发布系统）。
- 回滚方式：通过 Nextcloud 的文件版本/回收站回滚内容后，重新构建并发布。
- 失败处理：构建失败直接报错并退出（非 0）；不触碰已存在的 `dist/`，避免影响已发布版本。

## 可执行步骤

### 1) 拉取内容（手动）

```bash
npm run fetch
```

输出目录：`posts/`（默认，可通过 `LOCAL_POSTS_DIR` 覆盖）

配置来源：`.env.local`（参考 `.env.example`，仅用于构建机/本地拉取，不进入浏览器端产物）

### 2) 构建（手动）

```bash
npm run build
```

产物输出：`dist/`

### 3) 发布（手动）

- 将 `dist/` 同步到 Nginx 站点目录（示例路径：`/var/www/blog`）。
- 推荐发布策略：先同步到临时目录，再做一次原子替换（例如切换软链接），以避免发布过程中出现半成品。

### 4) 回滚（手动）

- 在 Nextcloud 中将 `posts/` 与 `assets/` 回滚到目标版本（文件版本/回收站）。
- 重新执行构建并发布：
  - `npm run fetch`
  - `npm run build`
  - 同步 `dist/` 到 Nginx 站点目录

## 约束与说明

- WebDAV 凭证只允许出现在构建环境（本地或 CI），不得进入浏览器端产物与日志输出。
- 当前阶段仅落地“手动触发 + 生成 `dist/`”的最小闭环；CI 触发与通知在后续工作包中补齐。
